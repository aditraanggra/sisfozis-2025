worker_processes auto;
daemon off;

events {
    worker_connections 1024;
}

http {
    include       /nix/store/vi6y42i66511s5vpi8vdlszs44b2sdn1-dbc4f15b899ac77a8d408d8e0f89fa9c0c5f2b78-env/conf/mime.types;
    default_type  application/octet-stream;
    index         index.php;

    log_format main '$remote_addr - $remote_user [$time_local] $status '
                    '"$request" $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /dev/stdout main;
    error_log  /dev/stderr warn;

    sendfile        on;
    tcp_nopush      on;
    server_names_hash_bucket_size 128;

    gzip on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;

    server {
        listen      8000 default_server;
        listen      [::]:8000 default_server;

        server_name _;
        root        /app/public;
        index       index.php;
        charset     utf-8;

        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";
        add_header Content-Security-Policy "upgrade-insecure-requests" always;

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location = /favicon.ico { 
        access_log off; 
        log_not_found off; 
        }
        location = /robots.txt  { 
            access_log off; 
            log_not_found off;
             }

        # Serve Livewire JS directly as static files to guarantee Content-Type
        location = /livewire/livewire.min.js {
            alias /app/vendor/livewire/livewire/dist/livewire.min.js;
            access_log off;
            expires 7d;
            # Ensure correct MIME type for JS
            default_type application/javascript;
        }

        location = /livewire/livewire.min.js.map {
            alias /app/vendor/livewire/livewire/dist/livewire.min.js.map;
            access_log off;
            expires 7d;
            default_type application/json;
        }

        # If the app injects /livewire/livewire.js while only the
        # production route /livewire/livewire.min.js exists, redirect it.
        location = /livewire/livewire.js {
            return 302 /livewire/livewire.min.js$is_args$args;
        }

        # Ensure remaining Livewire endpoints are handled by PHP (route-driven)
        location ^~ /livewire/ {
            try_files $uri /index.php?$query_string;
        }

        # Static assets
        location ~* \.(?:css|js|png|jpg|jpeg|gif|svg|ico|webp|woff2?|ttf|eot)$ {
            access_log off;
            expires 7d;
            try_files $uri $uri/ /index.php?$query_string;
        }

        location ~ \.php$ {
            try_files $uri =404;
            
            # Nix includes
            include /nix/store/vi6y42i66511s5vpi8vdlszs44b2sdn1-dbc4f15b899ac77a8d408d8e0f89fa9c0c5f2b78-env/conf/fastcgi_params;
            include /nix/store/vi6y42i66511s5vpi8vdlszs44b2sdn1-dbc4f15b899ac77a8d408d8e0f89fa9c0c5f2b78-env/conf/fastcgi.conf;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            fastcgi_param DOCUMENT_ROOT   $realpath_root;

            fastcgi_param HTTP_X_FORWARDED_PROTO  $http_x_forwarded_proto;
            fastcgi_param HTTP_X_FORWARDED_PORT   $http_x_forwarded_port;
            fastcgi_param HTTP_X_FORWARDED_HOST   $http_host;
            fastcgi_param HTTP_X_FORWARDED_FOR    $proxy_add_x_forwarded_for;

            # Helpful for AJAX/Livewire
            fastcgi_param HTTP_X_LIVEWIRE       $http_x_livewire;
            fastcgi_param HTTP_X_REQUESTED_WITH $http_x_requested_with;
            fastcgi_param HTTP_X_CSRF_TOKEN     $http_x_csrf_token;
            fastcgi_param HTTP_ACCEPT           $http_accept;

            fastcgi_pass 127.0.0.1:9000;
            fastcgi_index index.php;
        }

        location ~ /\. { 
            deny all; 
            }
        location ~ /\.(?!well-known).* { 
            deny all;
             }
    }
}